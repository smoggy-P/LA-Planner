<launch>
  <arg name="auto_trigger" />

  <arg name="map_size_x" />
  <arg name="map_size_y" />
  <arg name="map_size_z" />

  <arg name="box_min_x" />
  <arg name="box_min_y" />
  <arg name="box_min_z" />
  <arg name="box_max_x" />
  <arg name="box_max_y" />
  <arg name="box_max_z" />

  <arg name="odometry_topic" />
  <arg name="sensor_pose_topic" />
  <arg name="depth_topic" />
  <arg name="cloud_topic" />

  <arg name="cx" />
  <arg name="cy" />
  <arg name="fx" />
  <arg name="fy" />

  <arg name="max_vel" />
  <arg name="max_acc" />
  <arg name="max_yaw_rate" />

  <arg name="feature_filename" />
  <arg name="ft_param_filename" />

  <arg name="min_feature_num_act" />
  <arg name="min_covisible_feature_num_act" />

  <arg name="min_feature_num_plan" />
  <arg name="min_covisible_feature_num_plan" />

  <arg name="flight_type" />

  <arg name="point_num" />

  <arg name="point0_x" />
  <arg name="point0_y" />
  <arg name="point0_z" />

  <arg name="point1_x" />
  <arg name="point1_y" />
  <arg name="point1_z" />

  <arg name="replan_time" />
  <arg name="replan_out" />
  <arg name="thresh_replan1" />
  <arg name="thresh_replan2" />
  <arg name="thresh_replan3" />
  <arg name="thresh_replan4" />

  <!-- main node -->
  <node pkg="exploration_manager" name="exploration_node" type="exploration_node" output="screen">

    <!-- Failure Detector -->
    <param name="failure_detect/min_check_freq" value="40.0" type="double" />
    <!-- Dont't set it if you don't want to record the record of failure detector-->
    <!-- <param name="failure_detect/output_path" value="your path" type="string" /> -->

    <!-- Global Param -->
    <param name="global/min_feature_num_act" value="$(arg min_feature_num_act)" type="int" />
    <param name="global/min_covisible_feature_num_act" value="$(arg min_covisible_feature_num_act)" type="int" />
    <param name="global/min_feature_num_plan" value="$(arg min_feature_num_plan)" type="int" />
    <param name="global/min_covisible_feature_num_plan" value="$(arg min_covisible_feature_num_plan)" type="int" />

    <param name="global/max_vel" value="$(arg max_vel)" type="double" />
    <param name="global/max_acc" value="$(arg max_acc)" type="double" />
    <param name="global/max_yaw_rate" value="$(arg max_yaw_rate)" type="double" />

    <param name="global/max_tol_time" value="0.45" type="double" />

    <rosparam command="load" file="$(find utils)/config/cam.yaml" />

    <!-- Feature Map -->
    <param name="feature/filename" value="$(arg feature_filename)" />
    <param name="feature/occupied_thr" value="3" />

    <!-- Obstacle Map -->
    <remap from="/odom_world" to="$(arg odometry_topic)" />
    <remap from="/map_ros/pose" to="$(arg sensor_pose_topic)" />
    <remap from="/map_ros/depth" to="$(arg depth_topic)" />
    <remap from="/map_ros/cloud" to="$(arg cloud_topic)" />

    <param name="sdf_map/resolution" value="0.1" />
    <param name="sdf_map/map_size_x" value="$(arg map_size_x)" />
    <param name="sdf_map/map_size_y" value="$(arg map_size_y)" />
    <param name="sdf_map/map_size_z" value="$(arg map_size_z)" />
    <!-- <param name="sdf_map/obstacles_inflation" value="0.099" />  -->
    <param name="sdf_map/obstacles_inflation" value="0.199" />
    <param name="sdf_map/local_bound_inflate" value="0.5" />
    <param name="sdf_map/local_map_margin" value="50" />
    <param name="sdf_map/ground_height" value="-1.0" />
    <param name="sdf_map/default_dist" value="0.0" />

    <param name="sdf_map/p_hit" value="0.65" />
    <param name="sdf_map/p_miss" value="0.35" />
    <param name="sdf_map/p_min" value="0.12" />
    <param name="sdf_map/p_max" value="0.90" />
    <param name="sdf_map/p_occ" value="0.80" />
    <param name="sdf_map/min_ray_length" value="0.5" />
    <param name="sdf_map/max_ray_length" value="4.5" />
    <param name="sdf_map/virtual_ceil_height" value="-10" />
    <param name="sdf_map/optimistic" value="false" type="bool" />
    <param name="sdf_map/signed_dist" value="false" type="bool" />
    <param name="sdf_map/box_min_x" value="$(arg box_min_x)" type="double" />
    <param name="sdf_map/box_min_y" value="$(arg box_min_y)" type="double" />
    <param name="sdf_map/box_min_z" value="$(arg box_min_z)" type="double" />
    <param name="sdf_map/box_max_x" value="$(arg box_max_x)" type="double" />
    <param name="sdf_map/box_max_y" value="$(arg box_max_y)" type="double" />
    <param name="sdf_map/box_max_z" value="$(arg box_max_z)" type="double" />

    <param name="map_ros/cx" value="$(arg cx)" />
    <param name="map_ros/cy" value="$(arg cy)" />
    <param name="map_ros/fx" value="$(arg fx)" />
    <param name="map_ros/fy" value="$(arg fy)" />
    <param name="map_ros/depth_filter_maxdist" value="5.0" />
    <param name="map_ros/depth_filter_mindist" value="0.2" />
    <param name="map_ros/depth_filter_margin" value="2" />
    <param name="map_ros/k_depth_scaling_factor" value="1000.0" />
    <param name="map_ros/skip_pixel" value="2" />
    <param name="map_ros/esdf_slice_height" value="1.5" />
    <param name="map_ros/visualization_truncate_height" value="5.7" />
    <param name="map_ros/visualization_truncate_low" value="-0.1" />
    <param name="map_ros/show_occ_time" value="false" />
    <param name="map_ros/show_esdf_time" value="false" />
    <param name="map_ros/show_all_map" value="true" />
    <param name="map_ros/frame_id" value="world" />

    <!-- Fsm -->
    <param name="fsm/auto_trigger" value="$(arg auto_trigger)" type="bool" />
    <param name="fsm/thresh_replan1" value="$(arg thresh_replan1)" type="double" />
    <param name="fsm/thresh_replan2" value="$(arg thresh_replan2)" type="double" />
    <param name="fsm/thresh_replan3" value="$(arg thresh_replan3)" type="double" />
    <param name="fsm/thresh_replan4" value="$(arg thresh_replan4)" type="double" />
    <param name="fsm/replan_time" value="$(arg replan_time)" type="double" />
    <param name="fsm/replan_out" value="$(arg replan_out)" type="double" />
    <param name="fsm/flight_type" value="$(arg flight_type)" type="int" />
    <param name="fsm/visual_yaw_type" value="1" type="int" />

    <param name="fsm/end_state_file_path" value="$(find exploration_manager)/output/" type="string" />
    <param name="fsm/wp_num" value="$(arg point_num)" type="int" />
    <param name="fsm/wp0_x" value="$(arg point0_x)" type="double" />
    <param name="fsm/wp0_y" value="$(arg point0_y)" type="double" />
    <param name="fsm/wp0_z" value="$(arg point0_z)" type="double" />
    <param name="fsm/wp1_x" value="$(arg point1_x)" type="double" />
    <param name="fsm/wp1_y" value="$(arg point1_y)" type="double" />
    <param name="fsm/wp1_z" value="$(arg point1_z)" type="double" />

    <!-- Frontier -->
    <param name="frontier/cluster_min" value="100" type="int" />
    <param name="frontier/cluster_size_xy" value="2.0" type="double" />
    <param name="frontier/min_candidate_clearance" value="0.21" type="double" />
    <param name="frontier/ceiling_dir" value="0.5" type="double" />
    <param name="frontier/down_sample" value="3" type="int" />
    <param name="frontier/min_visib_num" value="15" type="int" />
    <param name="frontier/min_view_finish_fraction" value="0.8" type="double" />
    <rosparam command="load" file="$(arg ft_param_filename)" />

    <!-- Frontier (Visualization) -->
    <param name="frontier/visual_scores" value="true" type="bool" />
    <param name="frontier/visual_all_frontier" value="true" type="bool" />
    <param name="frontier/visual_feature_cluster" value="true" type="bool" />
    <param name="frontier/visual_feature_viewpoint" value="false" type="bool" />
    <param name="frontier/visual_frontier_viewpoint" value="true" type="bool" />
    <param name="frontier/visual_final_viewpoint" value="true" type="bool" />
    <param name="frontier/visual_astar_path" value="false" type="bool" />

    <!-- Yaw planner utils -->
    <param name="yaw_initial/piece_num" value="36" type="int" />
    <param name="yaw_initial/ld_smoothness" value="60.0" type="double" />
    <param name="yaw_initial/ld_expl" value="2.0" type="double" />
    <param name="yaw_initial/ld_frontier" value="0.2" type="double" />
    <param name="yaw_initial/ld_final_goal" value="10.0" type="double" />

    <!-- Yaw Optimize utils -->
    <param name="yaw_traj_opt/max_yaw_dot" value="$(arg max_yaw_rate)" type="double" />
    <param name="yaw_traj_opt/max_yaw_dotdot" value="3.0" type="double" />
    <param name="yaw_traj_opt/ld_feasi" value="40000.0" type="double" />
    <param name="yaw_traj_opt/ld_expl" value="30.0" type="double" />
    <param name="yaw_traj_opt/ld_weight1" value="50.0" type="double" />
    <param name="yaw_traj_opt/ld_weight2" value="10.0" type="double" />
    <param name="yaw_traj_opt/constraint_points_perPiece" value="5" type="int" />
    <param name="yaw_traj_opt/k1" value="40.0" type="double" />
    <param name="yaw_traj_opt/k2" value="10.0" type="double" />
    <param name="yaw_traj_opt/k3" value="20.0" type="double" />

    <!-- Planner manager -->
    <param name="manager/max_vel" value="$(arg max_vel)" type="double" />
    <param name="manager/max_acc" value="$(arg max_acc)" type="double" />
    <param name="manager/max_jerk" value="4" type="double" />
    <param name="manager/control_points_distance" value="0.5" type="double" />
    <param name="manager/min_observed_ratio" value="0.3" type="double" />
    <param name="manager/adjust_end_state" value="true" type="bool" />

    <!-- Kinodynamic path searching -->
    <param name="search/max_tau" value="0.8" type="double" />
    <param name="search/init_max_tau" value="1.0" type="double" />
    <param name="search/max_vel" value="$(arg max_vel)" type="double" />
    <param name="search/vel_margin" value="0.25" type="double" />
    <param name="search/max_acc" value="$(arg max_acc)" type="double" />
    <param name="search/w_time" value="10.0" type="double" />
    <param name="search/horizon" value="5.0" type="double" />
    <param name="search/lambda_heu" value="10.0" type="double" />
    <param name="search/resolution_astar" value="0.025" type="double" />
    <param name="search/time_resolution" value="0.8" type="double" />
    <param name="search/margin" value="0.2" type="double" />
    <param name="search/allocate_num" value="100000" type="int" />
    <param name="search/check_num" value="10" type="int" />
    <param name="search/initial_safe_ignore_limit" value="5" type="int" />
    <param name="search/optimistic" value="false" type="bool" />

    <param name="search/max_yaw_rate" value="$(arg max_yaw_rate)" type="double" />
    <param name="search/yaw_origin" value="-1000.0" type="double" />
    <param name="search/yaw_size" value="2000.0" type="double" />

    <param name="astar/lambda_heu" value="10000.0" type="double" />
    <param name="astar/resolution_astar" value="0.2" type="double" />
    <param name="astar/allocate_num" value="1000000" type="int" />
    <param name="astar/max_search_time" value="0.1" type="double" />
    <param name="astar/isplan2unknow" value="true" type="bool" />

    <!-- Bspline Optimize-->
    <param name="optimization/ld_smooth" value="20.0" type="double" />
    <param name="optimization/ld_dist" value="100.0" type="double" />
    <param name="optimization/ld_feasi" value="50.0" type="double" />
    <param name="optimization/ld_start" value="100.0" type="double" />
    <param name="optimization/ld_end" value="10000.0" type="double" />
    <param name="optimization/ld_guide" value="1.5" type="double" />
    <param name="optimization/ld_waypt" value="0.3" type="double" />
    <param name="optimization/ld_time" value="1.0" type="double" />

    <param name="optimization/dist0" value="0.7" type="double" />
    <param name="optimization/max_vel" value="$(arg max_vel)" type="double" />
    <param name="optimization/max_acc" value="$(arg max_acc)" type="double" />
    <param name="optimization/algorithm1" value="15" type="int" />
    <param name="optimization/algorithm2" value="11" type="int" />
    <param name="optimization/use_lbfgs" value="true" type="bool" />
    <param name="optimization/max_iteration_num1" value="2" type="int" />
    <param name="optimization/max_iteration_num2" value="2000" type="int" />
    <param name="optimization/max_iteration_num3" value="200" type="int" />
    <param name="optimization/max_iteration_num4" value="200" type="int" />

    <param name="optimization/max_iteration_time1" value="0.0001" type="double" />
    <param name="optimization/max_iteration_time2" value="0.005" type="double" />
    <param name="optimization/max_iteration_time3" value="0.003" type="double" />
    <param name="optimization/max_iteration_time4" value="0.003" type="double" />

    <param name="bspline/limit_vel" value="$(arg max_vel)" type="double" />
    <param name="bspline/limit_acc" value="$(arg max_acc)" type="double" />
    <param name="bspline/limit_ratio" value="1.1" type="double" />
    <param name="bspline/limit_vel" value="$(arg max_vel)" type="double" />
    <param name="bspline/limit_acc" value="$(arg max_acc)" type="double" />
    <param name="bspline/limit_ratio" value="1.1" type="double" />

  </node>

</launch>